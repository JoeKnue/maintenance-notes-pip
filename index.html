<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Maintenance Notes – PiP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font: 14px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:10px; align-items:center; margin: 10px 0; flex-wrap: wrap; }
    .btn { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background:#f7f7f7; cursor:pointer; }
    input[type="text"] { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width: 280px; }
    .ok { color:#0a7; } .err { color:#c00; } .muted{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h3>Maintenance Notes – Picture-in-Picture</h3>

  <div class="row">
    <label for="email">Your work email:</label>
    <input id="email" type="text" placeholder="you@company.com">
    <button class="btn" id="saveEmail" onclick="MN_saveEmail()">Save email</button>
  </div>
  <div class="muted">Saved locally in your browser so each note is tagged with you.</div>

  <div class="row">
    <button class="btn" id="open" onclick="MN_openPiP()" disabled>Open PiP</button>
    <span id="status"></span>
  </div>

<script>
(function () {
  const ENDPOINT = "https://script.google.com/a/macros/flyzipline.com/s/AKfycbyGlhqRheRLiv6Bs_mwGh3tqTCXmqZre8BBj64jfzah5hB7u_0_HxEQrFNDpgKMLecu/exec";

  const emailInput = document.getElementById('email');
  const openBtn = document.getElementById('open');
  const statusEl = document.getElementById('status');

  // Load saved email (or ?email= from URL)
  const params = new URLSearchParams(location.search);
  const qEmail = params.get('email');
  if (qEmail) localStorage.setItem('mn_email', qEmail);

  function loadEmail() {
    const e = localStorage.getItem('mn_email') || '';
    emailInput.value = e;
    openBtn.disabled = !e;
  }
  loadEmail();

  // Helpers
  function buildUrl(note, email) {
    return ENDPOINT
      + '?rawInput=' + encodeURIComponent(note)
      + '&email=' + encodeURIComponent(email)
      + '&t=' + Date.now();
  }
  async function sendGET(url) {
    // Fire via fetch and Image as a belt-and-suspenders fallback
    try { await fetch(url, { method: 'GET', mode: 'no-cors', cache: 'no-store' }); } catch (_) {}
    try { const img = new Image(); img.src = url; } catch (_) {}
  }

  // Expose for inline onclicks
  window.MN_saveEmail = function () {
    const e = emailInput.value.trim();
    if (!e || !e.includes('@')) { alert('Please enter a valid work email'); return; }
    localStorage.setItem('mn_email', e);
    openBtn.disabled = false;
    statusEl.textContent = 'Email saved.';
  };

  window.MN_openPiP = async function () {
    const EMAIL = localStorage.getItem('mn_email') || '';
    if (!EMAIL) { alert('Please save your work email first.'); return; }
    if (!('documentPictureInPicture' in window)) {
      statusEl.innerHTML = '<span class="err">Your browser doesn’t support Picture-in-Picture.</span>';
      return;
    }
    try {
      const pip = await documentPictureInPicture.requestWindow({ width: 360, height: 160 });
      pip.document.body.innerHTML = `
        <style>
          body { margin: 8px; font: 13px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
          .t { font-weight: 800; margin-bottom: 6px; }
          .row { display:flex; gap:6px; }
          input { flex:1; padding:6px 8px; border:1px solid #bbb; border-radius:8px; }
          .s { font-size:12px; min-height:18px; margin-top:6px; }
        </style>
        <div class="t">Maintenance Notes</div>
        <div class="row"><input id="i" placeholder="2427 / tower-100: Need the bleed valve tool to raise tower" /></div>
        <div id="s" class="s"></div>
      `;
      const i = pip.document.getElementById('i');
      const s = pip.document.getElementById('s');

      async function save(val) {
        if (!val) return;
        s.textContent = 'Saving...';
        const url = buildUrl(val, EMAIL);
        await sendGET(url);
        s.textContent = 'Saved ✔';
        i.value = '';
        setTimeout(() => s.textContent = '', 1000);
      }
      i.addEventListener('keydown', e => { if (e.key === 'Enter') save(i.value.trim()); });
      i.focus();
      statusEl.innerHTML = '<span class="ok">PiP opened.</span>';
    } catch (e) {
      statusEl.innerHTML = '<span class="err">PiP failed: ' + (e && e.message ? e.message : e) + '</span>';
      console.error(e);
    }
  };
})();
</script>
</body>
</html>

