<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Maintenance Notes – PiP (diag)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font: 14px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .row { display:flex; gap:10px; align-items:center; margin: 10px 0; flex-wrap: wrap; }
    .btn { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; background:#f7f7f7; cursor:pointer; }
    input[type="text"] { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width: 280px; }
    .ok { color:#0a7; } .err { color:#c00; } .muted{color:#666;font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px}
  </style>
</head>
<body>
  <h3>Maintenance Notes – Picture-in-Picture</h3>

  <div class="row">
    <label for="email">Your work email:</label>
    <input id="email" type="text" placeholder="you@company.com">
    <button class="btn" id="saveEmail" onclick="MN_saveEmail()">Save email</button>
  </div>
  <div class="muted">Saved locally in your browser so each note is tagged with you.</div>

  <div class="row">
    <button class="btn" id="open" onclick="MN_openPiP()" disabled>Open PiP</button>
    <span id="status"></span>
  </div>

  <hr>

  <!-- Diagnostics: show endpoint + simple test send -->
  <div class="row">
    <input id="testInput" type="text" placeholder="Test note (no PiP)" style="min-width:360px">
    <button class="btn" onclick="MN_sendTest()">Send test (no PiP)</button>
    <a class="btn" id="openGet" target="_blank" rel="noopener">Open raw save URL</a>
    <span id="testStatus"></span>
  </div>
  <div class="muted mono" id="ep"></div>

<script>
(function () {
  const ENDPOINT = "https://script.google.com/a/macros/flyzipline.com/s/AKfycbyGlhqRheRLiv6Bs_mwGh3tqTCXmqZre8BBj64jfzah5hB7u_0_HxEQrFNDpgKMLecu/exec";
 
  const LOG_URL = "https://docs.google.com/spreadsheets/d/1AhwogW4ui3CJdduNEjIcSReC2Y7ZcMUZyxATad0XGVo/edit?usp=sharing";

  // Show endpoint on page so we can visually confirm it's correct
  const epEl = document.getElementById('ep');
  epEl.textContent = 'Endpoint: ' + ENDPOINT;

  const emailInput = document.getElementById('email');
  const openBtn = document.getElementById('open');
  const statusEl = document.getElementById('status');
  const testInput = document.getElementById('testInput');
  const testStatus = document.getElementById('testStatus');
  const openGetLink = document.getElementById('openGet');

  // Load saved email (or ?email=)
  const params = new URLSearchParams(location.search);
  const qEmail = params.get('email');
  if (qEmail) localStorage.setItem('mn_email', qEmail);

  function loadEmail() {
    const e = localStorage.getItem('mn_email') || '';
    emailInput.value = e;
    openBtn.disabled = !e;
  }
  loadEmail();

  // Helpers
  function buildUrl(note, email) {
    return ENDPOINT
      + '?rawInput=' + encodeURIComponent(note)
      + '&email=' + encodeURIComponent(email)
      + '&t=' + Date.now();
  }
  async function sendGET(url) {
    try { await fetch(url, { method: 'GET', mode: 'no-cors', cache: 'no-store' }); } catch (_) {}
    try { const img = new Image(); img.src = url; } catch (_) {}
  }

  // Email save
  window.MN_saveEmail = function () {
    const e = emailInput.value.trim();
    if (!e || !e.includes('@')) { alert('Please enter a valid work email'); return; }
    localStorage.setItem('mn_email', e);
    openBtn.disabled = false;
    statusEl.textContent = 'Email saved.';
  };

  // Direct test (no PiP)
  window.MN_sendTest = async function () {
    const EMAIL = localStorage.getItem('mn_email') || '';
    if (!EMAIL) { alert('Save your work email first.'); return; }
    const note = testInput.value.trim() || 'launcher test';
    const url = buildUrl(note, EMAIL);
    openGetLink.href = url; // so you can click and see "Saved:" in a new tab
    testStatus.textContent = 'Sending...';
    await sendGET(url);
    testStatus.textContent = 'Sent ✔  (check the sheet)';
    testInput.value = '';
    setTimeout(() => testStatus.textContent = '', 1200);
  };

  // Image -> base64 (resized) helper
  async function imageToBase64(file, maxDim=1280, quality=0.8) {
    const dataUrl = await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
    const img = await new Promise((resolve, reject) => {
      const im = new Image();
      im.onload = () => resolve(im);
      im.onerror = reject;
      im.src = dataUrl;
    });
    const canvas = document.createElement('canvas');
    let { width, height } = img;
    if (width > height && width > maxDim) { height = Math.round(height * (maxDim / width)); width = maxDim; }
    else if (height > width && height > maxDim) { width = Math.round(width * (maxDim / height)); height = maxDim; }
    else if (width === height && width > maxDim) { width = height = maxDim; }
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);
    return canvas.toDataURL('image/jpeg', quality); // "data:image/jpeg;base64,..."
  }

  // Open PiP with link + photo support
  window.MN_openPiP = async function () {
    const EMAIL = localStorage.getItem('mn_email') || '';
    if (!EMAIL) { alert('Please save your work email first.'); return; }
    if (!('documentPictureInPicture' in window)) {
      statusEl.innerHTML = '<span class="err">Your browser doesn’t support Picture-in-Picture.</span>';
      return;
    }
    try {
      const pip = await documentPictureInPicture.requestWindow({ width: 380, height: 240 });
      pip.document.body.innerHTML = `
        <style>
          body { margin: 8px; font: 13px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
          .t { font-weight: 800; margin-bottom: 6px; }
          .row { display:flex; gap:6px; align-items:center; }
          input[type="text"] { flex:1; padding:6px 8px; border:1px solid #bbb; border-radius:8px; }
          .s { font-size:12px; min-height:18px; margin-top:6px; }
          .footer { margin-top:8px; }
          a { color:#06c; text-decoration:none; }
          a:hover { text-decoration:underline; }
        </style>
        <div class="t">Maintenance Notes</div>
        <div class="row">
          <input id="i" type="text" placeholder="Dallas / ZIP-0123: missing dock nut..." />
        </div>
        <div class="row">
          <input id="f" type="file" accept="image/*" />
          <span id="fstatus" class="s"></span>
        </div>
        <div id="s" class="s"></div>
        <div class="footer"><a href="${LOG_URL}" target="_blank">Maintenance Notes Log</a></div>
      `;
      const i = pip.document.getElementById('i');
      const s = pip.document.getElementById('s');
      const f = pip.document.getElementById('f');
      const fstatus = pip.document.getElementById('fstatus');

      let pendingBase64 = '';
      f.addEventListener('change', async () => {
        const file = f.files && f.files[0];
        if (!file) { pendingBase64 = ''; fstatus.textContent = ''; return; }
        fstatus.textContent = 'Processing photo...';
        try {
          pendingBase64 = await imageToBase64(file, 1280, 0.8);
          fstatus.textContent = 'Photo ready ✔';
        } catch (e) {
          pendingBase64 = '';
          fstatus.textContent = 'Photo error';
        }
      });

      async function save(val) {
        if (!val) return;
        s.textContent = 'Saving...';
        try {
          if (pendingBase64) {
            // POST via FormData (avoids CORS preflight issues)
            const fd = new FormData();
            fd.append('rawInput', val);
            fd.append('email', EMAIL);
            fd.append('imageBase64', pendingBase64);
            await fetch(ENDPOINT, { method: 'POST', mode: 'no-cors', body: fd });
          } else {
            // Text-only: simple GET
            const url = buildUrl(val, EMAIL);
            await sendGET(url);
          }
          s.textContent = 'Saved ✔';
          i.value = '';
          f.value = '';
          pendingBase64 = '';
          fstatus.textContent = '';
          setTimeout(() => s.textContent = '', 1000);
        } catch (e) {
          s.textContent = 'Error: ' + (e && e.message ? e.message : e);
        }
      }

      i.addEventListener('keydown', e => { if (e.key === 'Enter') save(i.value.trim()); });
      i.focus();
      statusEl.innerHTML = '<span class="ok">PiP opened.</span>';
    } catch (e) {
      statusEl.innerHTML = '<span class="err">PiP failed: ' + (e && e.message ? e.message : e) + '</span>';
      console.error(e);
    }
  };
})();
</script>
</body>
</html>
